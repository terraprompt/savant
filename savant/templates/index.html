<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization Solver Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Optimization Solver Dashboard</h1>
            <div>
                <span class="mr-2">Welcome, {{ current_user.username }}</span>
                <a href="{{ url_for('logout') }}" class="text-blue-500 hover:underline">Logout</a>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">Problem Statement</h2>
                <select id="problem-select" class="w-full mb-2 p-2 border rounded" hx-get="/load_problem/" hx-target="#problem-description" hx-trigger="change">
                    <option value="">Select a problem</option>
                    {% for problem in problems %}
                    <option value="{{ problem.id }}">Problem {{ problem.id }}</option>
                    {% endfor %}
                </select>
                <textarea name="problem_description" id="problem-description" class="w-full h-40 p-2 border rounded" 
                    hx-post="/update_problem"
                    hx-trigger="keyup changed delay:500ms"
                    hx-target="#generated-code"
                    hx-include="this"
                    hx-swap="innerHTML"></textarea>
            </div>
            <div id="generated-code" class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">Generated Code</h2>
                <pre><code class="language-python"></code></pre>
            </div>
            <div id="log" class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">Log</h2>
                <div class="h-40 overflow-y-auto"></div>
            </div>
            <div id="solution" class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">Solution</h2>
                <div class="h-40 overflow-y-auto"></div>
                <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded"
                    hx-post="/solve_problem"
                    hx-include="#problem-description"
                    hx-target="#solution"
                    hx-swap="innerHTML">
                    Solve Problem
                </button>
            </div>
        </div>
    </div>
    <script>
        htmx.on("htmx:afterSwap", function(evt) {
            if (evt.detail.target.id === "generated-code") {
                const logElement = document.querySelector("#log div");
                const response = JSON.parse(evt.detail.xhr.response);
                if (response.error) {
                    logElement.innerHTML += `<p class="text-red-500">${new Date().toLocaleTimeString()}: Error: ${response.error}</p>`;
                } else {
                    logElement.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${response.log}</p>`;
                }
                logElement.scrollTop = logElement.scrollHeight;
                Prism.highlightAll();
            } else if (evt.detail.target.id === "problem-description") {
                const response = JSON.parse(evt.detail.xhr.response);
                evt.detail.target.value = response.description;
            }
        });
    </script>
</body>
</html>